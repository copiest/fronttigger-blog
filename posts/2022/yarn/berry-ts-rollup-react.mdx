---
title: yarn berry + typescript + rollup + react 프로젝트 환경 구성하기 #required
tags:
  - yarn
  - typescript
  - rollup
  - react
  - designsystem
published: true # required
date: '2022. 4. 24' # required
description: '베리베리 스트로베리 🍓' # required
thumbnailImg: '/thumbnail/2022/04/npm/npm-link.png' # required
---

import Image from './src/components/image'

현재 사내에서는 디자인 시스템에 대한 관심이 핫하다. 🔥

최근 회사 전반적인 부분에 대한 큰 개편이 이루어졌고 이에 맞춰서 방향성이 나왔는데, 이 방향성에 대해서 앞으로 어떻게 개발해야할지 이야기가 나오다가 이전부터 숙원사업이었던 디자인 시스템을 본격적으로 추진하여 앞으로의 개발에 활용하자는 결론이 나왔다.

사실 이전부터 디자인 시스템은 존재했지만 유명무실한 상태였고 특히나 웹 프로젝트에 사용되는 디자인 시스템이 구현되어있지도 않았고 컴포넌트 작업시 디자인 참고 정도로 사용되는 수준이었다.

그래서 이번 기회에 개편 방향성에 맞추어 정식 프로젝트(?)로 삼고 진행하기로 결정되었다.

여러가지 기술적인 부분들을 고민하다가 현재 웹 프로젝트의 용량, 빌드 속도가 굉장히 느리다는 부분을 인지하였고 이 부분에 대한 인사이트를 얻어 여러가지를 찾아본 결과
`yarn berry`를 활용한 패키지 매니징을 통해 용량 감소, 빌드 개선 등의 여러 경험을 공유한 [아티클](https://toss.tech/article/node-modules-and-yarn-berry)들을 보았다.

그래서 결론은 yarn berry를 사용하여 현재 웹 프로젝트에서 사용중인 typescript와 react로 디자인 시스템을 구현하기로 하였다.

본격적인 환경 구성을 하기 전 스터디 형태의 환경 구성을 진행했는데 이를 통한 경험을 공유하려 한다.

## Yarn Berry를 도입한 이유

일단 앞서 서론에서 간단하게 공유했지만 현재 서비스 중인 웹 프로젝트의 역사가 오래되었고 모든 서비스가 하나의 레파지토리에 들어가 있어서 규모가 매우 비대해진 상태다.

최근 대규모 프로젝트를 진행하며 이전의 레거시를 전부 걷어내지 못한 상황에서 많은 코드들이 작성되었고 이를 유지보수 하면서 걷어내야 했지만 생각만큼 쉽게 걷어내지 못해 꽤나 많은 양의 레거시를 묻어두게 되었다.

물론 이 말고도 여러가지의 이유가 많겠지만 이런 문제들이 하나씩 쌓여 결국 빌드와 CI 시간까지 영향이 갔고 특히 CI의 경우 10분 내외로 시간이 걸렸다.

그래서 이런 문제들을 해결해줄 Yarn Berry에 눈길이 갔고, 앞으로는 새로운 프로젝트부터 기존 프로젝트까지 마이그레이션 해보자는 목표를 가지고 있다.

## Yarn Berry Setup

기존에 npm 환경에서 작업을 했다면 yarn을 아예 설치하지 않았거나 설치만 해두고 npm 명령어를 통해 진행했을 것이다.

yarn berry는 yarn을 통해 설정할 수 있기 때문에 yarn을 설치해주어야 한다.

### yarn 설치

```bash
npm install -g yarn
```

### Yarn Berry 적용

yarn을 설치했다면 yarn berry를 사용하고싶은 프로젝트로 이동하여 적용한다.

```bash
yarn set version berry
yarn -v // 3.2.0
```

여기까지 진행했다면 아마 프로젝트에 `.yarn`,`.yarnrc.yml`, `.pnp.cjs`가 생겼을 것이다.  
간단하게 정리하자면 아래와 같다.

- .yarn : 기존 node_modules에 들어있던 의존성들이 들어갈 폴더와 플러그인 등이 관리가 될 폴더
- .yarnrc.yml : yarn을 사용할 때 필요한 설정 사항들이 관리되는 파일
- .pnp.cjs : plug n play 전략을 사용할 때 .yarn/cache에 저장된 의존성의 정보가 저장된 파일 (의존성을 찾을 때 사용된다.)

yarn berry의 의존성은 node_modules와는 다르게 `zipFS` 형태로 관리가 되는데 이로 인해 굳이 node_modules 처럼 디렉토리 구조를 생성하지 않아도 되어 **빠르다**. 그리고 버전별 하나의 zip을 가지고 있기 때문에 **중복**이 없으며 용량도 적다.

#### Zero-Install

우리는 이전까지 새로운 프로젝트를 clone 할 때 **npm install**을 통해 의존성을 설치하는 과정을 진행했다. 그렇게 오랜 시간이 걸리는건 아니지만 번거롭기도 했고 또한 의존성이 잘못 설치되는 경우도 가끔 있어 불미스러운 일이 발생하기도 했다.

하지만 이를 방지해주는 것이 바로 `Zero-Install`이다.

위에서 보았듯 zip으로 관리되어 상대적으로 용량이 적어졌다. 그래서 node_modules처럼 ignore 시키는 것이 아닌 있는 그대로를 레파지토리에 올려 clone 받는 개발자로 하여금 굳이 추가 설치를 하지 않고 **바로 사용**할 수 있도록 하는 것이다.

또한 **의존성 관리**를 직접 할 수 있게 되어 더욱 엄격한 의존성 관리가 가능하다.

만약 Zero-Install을 사용하고 싶다면 아래 내용을 `.gitignore`에 추가하면 된다.

```gitignore
# Yarn Zero-install
.yarn/*
!.yarn/cache
!.yarn/patches
!.yarn/plugins
!.yarn/releases
!.yarn/sdks
!.yarn/versions
```

하지만 굳이 필요가 없는 상황이라면 아래 내용을 추가하면 된다.

```gitignore
# Yarn Non zero-install
.yarn/*
!.yarn/patches
!.yarn/releases
!.yarn/plugins
!.yarn/sdks
!.yarn/versions
.pnp.*
```

여기까지 진행했다면 yarn berry를 통한 패키지 매니징 준비는 끝났다.

## Typescript Setup

yarn berry에서 타입스크립트를 사용하기 위해서는 추가적인 작업이 필요하다.

이전에는 node_modules에 있는 type를 받아왔지만 현재는 zip 형태로 되어있기 때문이다.

그렇기 때문에 vscode 기준에서는 **zipFS Plugin을 설치**해주어야 정상적으로 zip 형태를 읽어올 수 있다.

### tsconfig.json 생성

가장 기본이 되는 tsconfig.json을 생성한다.

```bash
tsc -init
```

이후 파일을 프로젝트 기호에 맞게 수정한다.

### typescript 의존성 설치

```bash
yarn add -D typescript @types/react @types/react-dom
```

자 여기까지 설치해도 아직 타입에 관련된건 전부 빨간줄이 뜨고 있을 것이다.

@@@불편 짤 이미지@@@

지극히 정상이니 조금만 참자

### 에디터 SDK 설치

PnP를 위해서 에디터별로 [SDK를 설치](https://yarnpkg.com/getting-started/editor-sdks)해야한다. vscode로 셋업을 진행했기 때문에 해당 명령어는 아래와 같다.

```bash
yarn dlx @yarnpkg/sdks vscode
```

위 명령어를 작성하고 문제가 없다면 `.yarn/sdks` 디렉토리가 생성 되었을 것이고, 사진과 같은 안내창이 뜬다.

@@@이미지@@@

이는 해당 프로젝트에서 사용할 typescript 버전 허용 여부를 결정하는 부분인데 **Allow**를 선택하면 방금 추가된 typescript sdk를 사용하게 된다. (Allow 누르지 않으면 큰코 다침.. 🤥)

누르면 지금껏 눈을 힘들게 했던 빨간줄이 사라질 것이다.

@@@편안 짤 이미지@@@

## Rollup Setup

rollup을 사용한 이유는 ES Module 형태로 번들링을 하여 Tree Shaking을 지원하기 위함이다.

만약 디자인 시스템을 사용하는 프로젝트에서 Button 컴포넌트만 사용한다면 나머지 필요하지 않은 코드들은 빌드될 필요가 없다. ❌
그래서 ESM 형태로 바로 번들링이 되는 rollup 사용했다.
